{
  "pipeline_name": "NPE Demography Inference Pipeline",
  "version": "v9",
  "description": "Bayesian demographic inference for Fagus sylvatica using Neural Posterior Estimation with SLiM forward simulations",

  "configurations": [
    {
      "id": "config_production",
      "name": "Production Configuration",
      "path": "clean_pipeline_v9/config/config_individual_pops.yaml",
      "description": "100k simulations, 12 populations, 59 parameters, NSF [256,256]"
    },
    {
      "id": "config_pod",
      "name": "POD Testing Configuration",
      "path": "clean_pipeline_v9/config/config_pod_individual.yaml",
      "description": "50k simulations for validation, NSF [128,128]"
    },
    {
      "id": "config_populations",
      "name": "Population Mapping",
      "path": "clean_pipeline_v9/config/groups_12individuals.csv",
      "description": "Maps 12 individual populations including P001 outgroup"
    }
  ],

  "nodes": [
    {
      "id": "compute_observed_summaries",
      "name": "Compute Observed Summaries",
      "type": "data_preparation",
      "script": "clean_pipeline_v9/r/compute_observed_summaries.R",
      "language": "R",
      "description": "Extract allele counts from Pool-seq data and compute poolfstat summary statistics",
      "inputs": [
        {
          "type": "file",
          "path": "Pooldata_demography.RData",
          "description": "Observed Pool-seq data"
        }
      ],
      "outputs": [
        {
          "type": "file",
          "path": "observed_data/observed_summaries.npz",
          "description": "Normalized summary statistics for observed data"
        }
      ],
      "dependencies": [],
      "estimated_runtime": "5-15 minutes"
    },

    {
      "id": "generate_simulations",
      "name": "Generate Training Simulations",
      "type": "simulation",
      "script": "clean_pipeline_v9/python/simulate.py",
      "language": "Python",
      "description": "Sample parameters from prior and run SLiM forward simulations in parallel",
      "inputs": [
        {
          "type": "config",
          "config_id": "config_production",
          "description": "Pipeline configuration with simulation count and priors"
        },
        {
          "type": "template",
          "path": "clean_pipeline_v9/templates/model_individual_pops.slim.tpl",
          "description": "SLiM script template for 12 populations"
        },
        {
          "type": "config",
          "config_id": "config_populations",
          "description": "Population grouping and mapping"
        }
      ],
      "outputs": [
        {
          "type": "file",
          "path": "simulations/sim_data.npz",
          "description": "Memory-mapped NPZ with X (summaries), Theta (parameters), theta_keys, pop_order"
        }
      ],
      "dependencies": [],
      "modules": [
        "npe_demography.config",
        "npe_demography.priors",
        "npe_demography.slim",
        "npe_demography.summaries",
        "npe_demography.transforms"
      ],
      "parallelization": {
        "method": "ProcessPoolExecutor",
        "workers": "CPU cores",
        "supports_multinode": true
      },
      "estimated_runtime": "2-12 hours (depending on node count)"
    },

    {
      "id": "train_npe_model",
      "name": "Train Neural Spline Flow",
      "type": "training",
      "script": "clean_pipeline_v9/python/train_npe.py",
      "language": "Python",
      "description": "Train NSF model to learn conditional density p(theta|x)",
      "inputs": [
        {
          "type": "file",
          "path": "simulations/sim_data.npz",
          "description": "Simulated parameter-summary pairs",
          "from_node": "generate_simulations"
        },
        {
          "type": "config",
          "config_id": "config_production",
          "description": "Neural architecture configuration"
        }
      ],
      "outputs": [
        {
          "type": "model",
          "path": "models/nsf_model.pt",
          "description": "Trained NSF checkpoint with scalers and metadata"
        }
      ],
      "dependencies": ["generate_simulations"],
      "modules": [
        "npe_demography.config",
        "npe_demography.sbi_backend",
        "npe_demography.nsf"
      ],
      "hyperparameters": {
        "hidden_sizes": "[256, 256]",
        "num_layers": 5,
        "learning_rate": 0.0003,
        "early_stopping_patience": 30
      },
      "estimated_runtime": "1-3 hours"
    },

    {
      "id": "infer_posterior",
      "name": "Infer Posterior",
      "type": "inference",
      "script": "clean_pipeline_v9/python/infer_posterior.py",
      "language": "Python",
      "description": "Sample posterior parameters given observed data",
      "inputs": [
        {
          "type": "model",
          "path": "models/nsf_model.pt",
          "description": "Trained NSF model",
          "from_node": "train_npe_model"
        },
        {
          "type": "file",
          "path": "observed_data/observed_summaries.npz",
          "description": "Observed summary statistics",
          "from_node": "compute_observed_summaries"
        },
        {
          "type": "config",
          "config_id": "config_production",
          "description": "Number of posterior samples to draw"
        }
      ],
      "outputs": [
        {
          "type": "file",
          "path": "results/posterior_samples.npz",
          "description": "20,000 posterior parameter samples"
        },
        {
          "type": "file",
          "path": "results/posterior_summary.json",
          "description": "Parameter estimates with 95% credible intervals"
        }
      ],
      "dependencies": ["train_npe_model", "compute_observed_summaries"],
      "modules": [
        "npe_demography.config",
        "npe_demography.sbi_backend",
        "npe_demography.transforms",
        "npe_demography.priors"
      ],
      "estimated_runtime": "5-15 minutes"
    },

    {
      "id": "generate_pod",
      "name": "Generate Pseudo-Observed Data",
      "type": "validation_preparation",
      "script": "clean_pipeline_v9/python/generate_pod.py",
      "language": "Python",
      "description": "Create synthetic observed data with known parameters for validation",
      "inputs": [
        {
          "type": "config",
          "config_id": "config_pod",
          "description": "POD configuration"
        },
        {
          "type": "template",
          "path": "clean_pipeline_v9/templates/model_individual_pops.slim.tpl",
          "description": "SLiM script template"
        }
      ],
      "outputs": [
        {
          "type": "file",
          "path": "pod_data/pod_observed_summaries.npz",
          "description": "Synthetic observed data"
        },
        {
          "type": "file",
          "path": "pod_data/pod_true_params.json",
          "description": "Ground truth parameters"
        }
      ],
      "dependencies": [],
      "modules": [
        "npe_demography.priors",
        "npe_demography.slim",
        "npe_demography.summaries"
      ],
      "estimated_runtime": "10-30 minutes"
    },

    {
      "id": "validate_sbc",
      "name": "Simulation-Based Calibration",
      "type": "validation",
      "script": "clean_pipeline_v9/python/validate_sbc.py",
      "language": "Python",
      "description": "Verify that inference is unbiased using SBC rank statistics",
      "inputs": [
        {
          "type": "model",
          "path": "models/nsf_model.pt",
          "description": "Trained NSF model",
          "from_node": "train_npe_model"
        },
        {
          "type": "config",
          "config_id": "config_pod",
          "description": "SBC validation configuration"
        }
      ],
      "outputs": [
        {
          "type": "file",
          "path": "validation/sbc_results.npz",
          "description": "SBC rank statistics for all parameters"
        },
        {
          "type": "file",
          "path": "validation/sbc_plots.pdf",
          "description": "Rank histogram plots"
        }
      ],
      "dependencies": ["train_npe_model"],
      "modules": [
        "npe_demography.sbi_backend",
        "npe_demography.priors"
      ],
      "estimated_runtime": "30-90 minutes"
    },

    {
      "id": "validate_ppc",
      "name": "Posterior Predictive Checks",
      "type": "validation",
      "script": "clean_pipeline_v9/python/validate_ppc.py",
      "language": "Python",
      "description": "Simulate data from posterior samples and compare to observed",
      "inputs": [
        {
          "type": "file",
          "path": "results/posterior_samples.npz",
          "description": "Posterior samples",
          "from_node": "infer_posterior"
        },
        {
          "type": "file",
          "path": "observed_data/observed_summaries.npz",
          "description": "Observed summaries",
          "from_node": "compute_observed_summaries"
        },
        {
          "type": "template",
          "path": "clean_pipeline_v9/templates/model_individual_pops.slim.tpl",
          "description": "SLiM template"
        }
      ],
      "outputs": [
        {
          "type": "file",
          "path": "validation/ppc_results.npz",
          "description": "Posterior predictive summary statistics"
        },
        {
          "type": "file",
          "path": "validation/ppc_plots.pdf",
          "description": "Comparison plots"
        }
      ],
      "dependencies": ["infer_posterior", "compute_observed_summaries"],
      "modules": [
        "npe_demography.slim",
        "npe_demography.summaries"
      ],
      "estimated_runtime": "1-2 hours"
    },

    {
      "id": "check_pod_recovery",
      "name": "Check POD Parameter Recovery",
      "type": "validation_analysis",
      "script": "clean_pipeline_v9/python/check_pod_recovery.py",
      "language": "Python",
      "description": "Analyze how well true parameters are recovered in POD test",
      "inputs": [
        {
          "type": "file",
          "path": "pod_results/posterior_samples.npz",
          "description": "POD posterior samples"
        },
        {
          "type": "file",
          "path": "pod_data/pod_true_params.json",
          "description": "Ground truth parameters",
          "from_node": "generate_pod"
        }
      ],
      "outputs": [
        {
          "type": "file",
          "path": "pod_results/recovery_analysis.json",
          "description": "Parameter recovery statistics"
        },
        {
          "type": "file",
          "path": "pod_results/recovery_plots.pdf",
          "description": "Recovery visualization"
        }
      ],
      "dependencies": ["generate_pod"],
      "estimated_runtime": "5-10 minutes"
    }
  ],

  "modules": [
    {
      "id": "config_module",
      "name": "Configuration Module",
      "path": "clean_pipeline_v9/python/npe_demography/config.py",
      "description": "YAML configuration loading and directory utilities",
      "exports": ["load_config", "ensure_dir"]
    },
    {
      "id": "priors_module",
      "name": "Prior Distributions",
      "path": "clean_pipeline_v9/python/npe_demography/priors.py",
      "description": "Parameter sampling with phylogenetic constraints",
      "exports": [
        "sample_from_prior",
        "sample_times_individual_pops",
        "theta_vector",
        "build_theta_keys",
        "build_size_anchors"
      ]
    },
    {
      "id": "slim_module",
      "name": "SLiM Interface",
      "path": "clean_pipeline_v9/python/npe_demography/slim.py",
      "description": "SLiM script rendering and execution with timeout handling",
      "exports": [
        "render_slim_script",
        "run_slim",
        "DEFAULT_MAPPING",
        "INDIVIDUAL_MAPPING"
      ]
    },
    {
      "id": "summaries_module",
      "name": "Summary Statistics",
      "path": "clean_pipeline_v9/python/npe_demography/summaries.py",
      "description": "Compute poolfstat summaries from tree sequences",
      "exports": [
        "overlay_mutations_if_needed",
        "get_sample_nodes_by_popname",
        "compute_summaries_from_trees"
      ]
    },
    {
      "id": "transforms_module",
      "name": "Parameter Transforms",
      "path": "clean_pipeline_v9/python/npe_demography/transforms.py",
      "description": "Biological <-> unconstrained parameter space mapping",
      "exports": [
        "transform_theta_vector",
        "inverse_transform_theta_vector"
      ]
    },
    {
      "id": "sbi_backend_module",
      "name": "SBI Backend",
      "path": "clean_pipeline_v9/python/npe_demography/sbi_backend.py",
      "description": "Neural Spline Flow training and inference",
      "exports": [
        "train_npe_sbi",
        "load_sbi_posterior"
      ]
    },
    {
      "id": "nsf_module",
      "name": "Neural Spline Flow",
      "path": "clean_pipeline_v9/python/npe_demography/nsf.py",
      "description": "NSF flow architecture implementation",
      "exports": ["NSF"]
    },
    {
      "id": "io_module",
      "name": "I/O Utilities",
      "path": "clean_pipeline_v9/python/npe_demography/io.py",
      "description": "Population group CSV reading",
      "exports": ["read_groups_csv"]
    },
    {
      "id": "mdn_module",
      "name": "Mixture Density Network",
      "path": "clean_pipeline_v9/python/npe_demography/mdn.py",
      "description": "Alternative MDN estimator",
      "exports": ["MDN"]
    }
  ],

  "orchestration_scripts": [
    {
      "id": "run_pod_test",
      "name": "POD Test (Single Node)",
      "path": "clean_pipeline_v9/scripts/run_pod_test_individual.sh",
      "description": "Validation with known parameters on single machine",
      "execution_mode": "single_node",
      "steps": ["generate_pod", "generate_simulations", "train_npe_model", "infer_posterior", "check_pod_recovery"]
    },
    {
      "id": "run_pod_multinode",
      "name": "POD Test (Multi-Node)",
      "path": "clean_pipeline_v9/scripts/run_pod_test_multinode_individual.sh",
      "description": "Distributed POD validation across SSH nodes",
      "execution_mode": "multi_node",
      "steps": ["generate_pod", "generate_simulations", "train_npe_model", "infer_posterior", "check_pod_recovery"]
    },
    {
      "id": "run_production",
      "name": "Production Pipeline (Single Node)",
      "path": "clean_pipeline_v9/scripts/run_production_individual.sh",
      "description": "Full inference on real observed data",
      "execution_mode": "single_node",
      "steps": ["compute_observed_summaries", "generate_simulations", "train_npe_model", "infer_posterior"]
    },
    {
      "id": "run_production_multinode",
      "name": "Production Pipeline (Multi-Node)",
      "path": "clean_pipeline_v9/scripts/run_production_multinode_individual.sh",
      "description": "Distributed production inference",
      "execution_mode": "multi_node",
      "steps": ["compute_observed_summaries", "generate_simulations", "train_npe_model", "infer_posterior"]
    }
  ],

  "workflows": {
    "production_workflow": {
      "name": "Production Demographic Inference",
      "description": "Full pipeline for inferring demographics from observed Pool-seq data",
      "steps": [
        "compute_observed_summaries",
        "generate_simulations",
        "train_npe_model",
        "infer_posterior",
        "validate_ppc"
      ]
    },
    "pod_validation_workflow": {
      "name": "POD Validation",
      "description": "Test parameter recovery with synthetic observed data",
      "steps": [
        "generate_pod",
        "generate_simulations",
        "train_npe_model",
        "infer_posterior",
        "check_pod_recovery"
      ]
    },
    "sbc_validation_workflow": {
      "name": "SBC Validation",
      "description": "Verify inference calibration",
      "steps": [
        "generate_simulations",
        "train_npe_model",
        "validate_sbc"
      ]
    }
  },

  "phylogenetic_model": {
    "description": "12 individual populations with 11 ghost nodes representing split events",
    "populations": [
      {"id": "p0", "name": "ancestral", "type": "ghost", "description": "Root ancestor"},
      {"id": "p1", "name": "P001", "type": "sampled", "description": "Outgroup population"},
      {"id": "p3", "name": "BG01", "type": "sampled", "description": "Bulgarian population 1"},
      {"id": "p8", "name": "BG05", "type": "sampled", "description": "Bulgarian population 5"},
      {"id": "p9", "name": "BG04", "type": "sampled", "description": "Bulgarian population 4"},
      {"id": "p10", "name": "BG07", "type": "sampled", "description": "Bulgarian population 7"},
      {"id": "p11", "name": "Sauva", "type": "sampled", "description": "Southern population"},
      {"id": "p13", "name": "Montsenymid", "type": "sampled", "description": "Northern population"},
      {"id": "p16", "name": "Carlac", "type": "sampled", "description": "Pyrenees population"},
      {"id": "p18", "name": "Conangles", "type": "sampled", "description": "Pyrenees population"},
      {"id": "p19", "name": "Viros", "type": "sampled", "description": "Pyrenees population"},
      {"id": "p21", "name": "Cimadal", "type": "sampled", "description": "Pyrenees population"},
      {"id": "p22", "name": "Coscollet", "type": "sampled", "description": "Pyrenees population"}
    ],
    "split_events": [
      "T_P001: p0 -> p1, p2",
      "T_BG01: p2 -> p3, p4",
      "T_MAJOR_SPLIT: p4 -> p5 (Southern), p12 (Northern)",
      "T_Sauva: p5 -> p11, p6",
      "T_BG07: p6 -> p10, p7",
      "T_BG05_BG04: p7 -> p8, p9",
      "T_Montsenymid: p12 -> p13, p14",
      "T_PYRENEES: p14 -> p15, p20",
      "T_Carlac: p15 -> p16, p17",
      "T_Conangles_Viros: p17 -> p18, p19",
      "T_Cimadal_Coscollet: p20 -> p21, p22"
    ],
    "parameters": {
      "split_times": 11,
      "population_sizes": 12,
      "bottleneck_params_per_pop": 3,
      "total_free_parameters": 59
    }
  },

  "data_dependencies": {
    "external_data": [
      {
        "name": "Pooldata_demography.RData",
        "description": "Observed Pool-seq allele count data for Fagus sylvatica",
        "format": "RData",
        "required_for": ["compute_observed_summaries"]
      }
    ],
    "generated_data": [
      {
        "name": "observed_summaries.npz",
        "path": "observed_data/",
        "description": "Processed summary statistics from observed data",
        "producers": ["compute_observed_summaries"],
        "consumers": ["infer_posterior", "validate_ppc"]
      },
      {
        "name": "sim_data.npz",
        "path": "simulations/",
        "description": "Training data (parameter-summary pairs)",
        "producers": ["generate_simulations"],
        "consumers": ["train_npe_model"]
      },
      {
        "name": "nsf_model.pt",
        "path": "models/",
        "description": "Trained neural posterior estimator",
        "producers": ["train_npe_model"],
        "consumers": ["infer_posterior", "validate_sbc"]
      },
      {
        "name": "posterior_samples.npz",
        "path": "results/",
        "description": "Final demographic inference results",
        "producers": ["infer_posterior"],
        "consumers": ["validate_ppc"]
      }
    ]
  },

  "technical_features": {
    "adaptive_scaling": "Scales SLiM simulations for memory efficiency (Ne_sim = Ne_bio / scale_factor)",
    "phylogenetic_constraints": "Enforces split time ordering (parent splits before children)",
    "parallel_processing": "ProcessPoolExecutor with CPU core workers",
    "multi_node_support": "SSH-based distributed simulation with automatic NPZ merging",
    "memory_efficiency": "Memory-mapped NPZ files, ghost populations set to N=1 after splitting",
    "validation_framework": ["POD (parameter recovery)", "SBC (unbiasedness)", "PPC (goodness-of-fit)"]
  },

  "metadata": {
    "created": "2026-02-14",
    "repository": "NPE-demography-inference-Pipeline",
    "species": "Fagus sylvatica (European beech)",
    "method": "Neural Posterior Estimation with SLiM forward simulations",
    "neural_architecture": "Neural Spline Flow (NSF)",
    "summary_statistics": "poolfstat (FST, allele frequencies, 2D histograms)"
  }
}
